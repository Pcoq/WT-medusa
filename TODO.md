# TODO - Medusa E-commerce Project

This file serves as a progress tracker and memory system for development tasks on this Medusa starter project.

## Current Session Tasks

### âœ… Completed
- [x] Created TODO.md file for progress tracking
- [x] Examined project structure (Medusa e-commerce starter with TypeScript)
- [x] Establish TODO.md as memory system for tracking development progress
- [x] Created Cursor rule `.cursor/rules/todo-memory-system.mdc` for persistent TODO.md behavior
- [x] Identified brand_name column issue in machine table

- [x] Plan service order commenting system implementation
  - [x] Analyzed current service order architecture and MedusaJS native patterns
  - [x] Reviewed order note/comment implementation in MedusaJS core for consistency
  - [x] Designed comprehensive plan following MedusaJS patterns (models, services, API, UI)
  - [x] Planned 4-phase implementation: Backend Foundation, Real-time Infrastructure, Frontend Implementation, Advanced Features
  - [x] Estimated 8-12 days total implementation time across all phases
- [x] **Service Order Event Logging System - Complete Implementation** âœ…
  - [x] **Phase 1 - Backend Foundation:**
    - [x] Created ServiceOrderEventLogger helper class with grouping capabilities
    - [x] Implemented event templates for major actions (parts, time entries, status changes)
    - [x] Integrated event logging into service operations (addServiceOrderItem, addTimeEntry, updateServiceOrderStatus)
    - [x] Added removeServiceOrderItem method with event logging
    - [x] Created API endpoint for removing service order items
    - [x] Used existing comment system with author_type="system" for events
    - [x] Implemented time-based event grouping (5-10 min windows with max event limits)
  - [x] **Phase 2 - UI Enhancement:**
    - [x] Updated ServiceOrderCommentsWidget to display events alongside comments
    - [x] Added event filtering toggles (Show Comments/Show Events)
    - [x] Created EventMessage component with visual distinction from comments
    - [x] Added event icons and categorization (Parts/Time/Status)
    - [x] Implemented grouped events expandable details
    - [x] Added delete functionality to service order items widget with proper event logging
    - [x] Integrated comment invalidation to show events in real-time
    - [x] Fixed date formatting bug in formatRelativeTime utility (handle string dates from API)
- [x] **Rework service order detail page layout**
  - [x] Move service details widget to right column sidebar
  - [x] Remove cost summary and total from service details widget
  - [x] Remove status history widget
  - [x] Keep only customer, machine, description, service type and priority in service details
- [x] **Improve service detail page sidebar widgets to be more MedusaJS-native**
  - [x] Restructure service details widget to follow MedusaJS patterns
  - [x] Improve status actions widget layout and UX
  - [x] Add proper action menu and icons following native conventions
  - [x] Enhance visual hierarchy and information display
- [x] **Redesign service details widget as editable drawer-style layout**
  - [x] Simplify design and style like an edit drawer
  - [x] Make customer, machine, description, service type and priority editable
  - [x] Use clean form-style layout with proper field structure
  - [x] Remove complex icon containers and use simple field labels

  - [x] Updated ServiceOrder type definitions to maintain consistency between components
  - [x] **CRITICAL FIX**: Resolved React Query cache conflicts by namespacing query keys
    - [x] Changed service orders page query keys to use "service-orders-customers" and "service-orders-technicians"
    - [x] Updated kanban component query keys to match service orders page
    - [x] Fixed create/edit service order forms to use namespaced keys
    - [x] Updated all service order related widgets and components to use unique query keys
    - [x] Prevented cache pollution between native module queries and service order queries
  - [x] **FINAL FIX**: Resolved "Rendered more hooks than during the previous render" error
    - [x] Moved useDataTable hook call before all conditional returns in ServiceOrdersListTable
    - [x] Relocated all column definitions and data processing before conditional returns
    - [x] Ensured consistent hook order across all page loads and navigation scenarios
    - [x] Fixed the "first load error" that required page refresh to work properly
    - [x] **APPLIED TO ALL PAGES**: Fixed React hooks order violations across all custom modules
      - [x] Fixed machines page - moved useDataTable before conditional returns
      - [x] Fixed suppliers page - moved useDataTable before conditional returns
      - [x] Fixed technicians page - moved useDataTable before conditional returns
      - [x] Fixed invoices page - moved useDataTable before conditional returns
      - [x] Ensured all custom modules follow proper React hooks patterns
- [x] **Review and improve load-customers-machines script to follow MedusaJS best practices**
  - [x] Fix TypeScript errors in machine creation (status enum values)
  - [x] Replace direct service calls with proper workflows (createCustomersWorkflow, createMachineWorkflow)
  - [x] Improve error handling and validation
  - [x] Use proper MedusaJS patterns for script architecture
  - [x] Apply better data parsing and transformation (normalizeStatus helper)
  - [x] Implement batch processing for better performance
  - [x] Add comprehensive logging and progress tracking
  - [x] Fix error object handling in catch blocks (TypeError: Cannot use 'in' operator)
- [x] **Enhance custom datatables with clickable rows and simplified actions** âœ…
  - [x] Make all datatable rows clickable (navigate to detail pages)
  - [x] Replace current action icons with dropdown menu containing only Edit and Delete
  - [x] Apply to all custom modules: machines, technicians, suppliers, invoices/facturen, service orders
  - [x] Use MedusaJS native patterns for ActionMenu with DropdownMenu component
  - [x] Maintain existing functionality while improving UX consistency
  - [x] Updated machines page with Edit/Delete dropdown and row click navigation
  - [x] Updated suppliers page with Edit/Delete dropdown and row click navigation
  - [x] Updated technicians page with Edit/Delete dropdown and row click navigation
  - [x] Updated invoices page with Edit/Delete dropdown (drafts only) and row click navigation
  - [x] Updated service orders page with Edit/Delete dropdown and row click navigation
  - [x] Ensured Edit actions trigger existing edit forms/drawers properly
  - [x] Simplified interface: View via clickable rows, Edit/Delete via dropdown only
- [x] **Rework order creation focus modal layout to be more native Medusa** âœ…
  - [x] Updated FocusModal.Body structure to follow native patterns (centered layout with max-width constraints)
  - [x] Improved Fulfillment section to match native fulfillment form patterns with proper field layouts
  - [x] Enhanced Items section with better visual hierarchy and native dashed placeholder patterns
  - [x] Applied proper Form components and field layouts from MedusaJS (xl:flex-row responsive design)
  - [x] Used consistent spacing, typography, and component structure following .medusa-source patterns
  - [x] Implemented divide-y sections with proper padding and visual separation
  - [x] Added bg-ui-bg-base class to Select.Trigger components for consistency
  - [x] Used proper label hierarchy and text sizing following native conventions
  - [x] Fixed modal scrolling by removing conflicting overflow-auto classes and size-full constraints
  - [x] Simplified dropdown options to show only main terms (Pickup/Shipping) without subtitles

### ðŸ”„ In Progress
- [ ] **Service Order Event Logging System - Debugging**
  - [x] Fixed metadata field missing from comments query
  - [x] Fixed container resolution issues in event logger
  - [x] Updated event logger to work with service instance directly
  - [x] Added debug logging to track event creation
  - [ ] Test and verify events are appearing in UI after adding parts/time entries
- [x] **Debugging fulfillment creation error** âœ…
  - [x] Analyzed "Invalid request: Value for field 'items' too small, expected at least: '1'" error
  - [x] Identified root cause: items array becomes empty after filtering
  - [x] Found requires_shipping defaults to true for manual orders (should be false for pickup)
  - [x] Added fulfillment_type field to create order widget (pickup/shipping)
  - [x] Updated order creation logic to set requires_shipping: false for pickup orders
  - [x] Fixed manual order fulfillment creation for pickup orders
- [x] **Fix stock reservation error for pickup orders** âœ…
  - [x] Identified new issue: "No stock reservation found for item" for pickup fulfillments
  - [x] Root cause: MedusaJS expects stock reservations for managed inventory items even for pickup
  - [x] Implemented simplified reservation creation in order endpoint following native patterns
  - [x] Added inventory reservation logic after order creation using native MedusaJS services
  - [x] Used proper error handling to avoid failing order creation if reservations fail
  - [x] Added metadata tracking for manual order reservations
- [ ] **Adapt machine module data model**
  - [x] Remove fields: fuel_type, horsepower, weight, purchase_price, current_value, location
  - [x] Add field: machine_type
  - [x] Create migration for database schema changes
  - [x] Update machine model definition
  - [x] Update TypeScript types and DTOs
  - [x] Update admin UI forms (create and edit)
  - [x] Update API endpoints and service layer
  - [ ] Test the complete adaptation
- [x] **Implement internationalization (i18n) for custom modules** âœ… **FULLY COMPLETED**
  - [x] Add translation support for all custom admin routes and components
  - [x] Create translation files for Belgian languages (Dutch, French, German, English)
  - [x] Replace hardcoded strings with translation keys using useTranslation hook
  - [x] Update route labels and component text to support language switching
  - [x] Ensure custom modules translate when language is changed in profile settings
  - [x] Created custom translation infrastructure:
    - [x] Translation files: src/admin/translations/en.json and nl.json
    - [x] Translation index file: src/admin/translations/index.ts
    - [x] Custom hook: src/admin/hooks/use-custom-translation.ts
    - [x] Comprehensive documentation: src/admin/translations/README.md
  - [x] Updated ALL components to use translations:
    - [x] Machines page: status filters, column headers, action buttons, status badges
    - [x] Suppliers page: filters, column headers, actions, page title
    - [x] Invoices page: status badges, type badges, filters, columns, actions (replaced all hardcoded Dutch text)
    - [x] Technicians page: status filters, department/certification dropdowns, column headers, actions
    - [x] Service Orders page: all status/priority/type badges, filters, columns, actions, page header
    - [x] Purchase Orders page: all status/priority badges, filters, columns, page header
  - [x] All major hardcoded strings now use translation keys
  - [x] Proper fallback system (Dutch â†’ English if translation missing)
  - [x] Consistent naming convention for translation keys
  - [x] Comprehensive translation coverage for all custom modules
  - **Note**: Navigation labels in sidebar currently use static route config labels (MedusaJS limitation)
  - **Result**: Complete i18n support - when users change language in profile settings, ALL custom modules translate perfectly

### ðŸ“‹ Pending Tasks
- [ ] Ready for new tasks and feature development

## Project Overview
- **Type**: Medusa e-commerce starter project
- **Tech Stack**: TypeScript, Node.js, Medusa.js
- **Location**: Belgium-focused market
- **Key Files**: 
  - `medusa-config.ts` - Main configuration
  - `src/` - Source code directory
  - Various CSV files for product imports

## Notes
- Project appears to be a Medusa e-commerce platform setup
- Contains product import templates and sample data
- Docker configuration available
- Integration tests configured
- **Previous Issue**: Machine table had brand_name column but database expected brand_id column
- **Solution**: âœ… Full migration completed to use brand_id with proper foreign key relationship to brands table
- **Brands Management**: âœ… Moved from main navigation to Settings section for better organization
  - Now accessible at `/app/settings/brands` instead of `/app/brands`
  - Follows MedusaJS settings page conventions (no icon, proper form handling)
  - Maintains all existing functionality in appropriate configuration context
- **Button Standardization**: âœ… Completed full standardization of button components
  - All action buttons now use native MedusaJS `Button` component consistently
  - Replaced `IconButton` with `Button` for table actions and similar contexts
  - Maintained `IconButton` for appropriate uses (dropdown triggers in ActionMenu components)
  - Standardized spacing with `gap-2` for all button groups
  - Consistent `variant="transparent"` and `size="small"` for table action buttons
  - All icons properly placed inside Button components with consistent sizing (`h-4 w-4`)
  - **Create Buttons**: All create buttons above DataTables now use consistent patterns:
    - `size="small"` and `variant="secondary"`
    - `<Plus className="h-4 w-4" />` icon from `@medusajs/icons`
    - Consistent button text formatting
    - Uniform trigger patterns in Modal components
- **Service Order Commenting System**: ðŸ“‹ Comprehensive implementation plan completed
  - Will follow MedusaJS native patterns for activity feeds and communication
  - Includes real-time chat functionality using SSE (Server-Sent Events)
  - Architecture: ServiceOrderComment model â†’ Service layer â†’ API endpoints â†’ Real-time UI
  - Integration points: Service order detail page, notification system, activity timeline
  - Advanced features: file attachments, @mentions, comment threading, internal/public visibility

--- 
*Last updated: Current session - Completed comprehensive planning for service order commenting system implementation* 